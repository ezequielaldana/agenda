<script>
  function insertarContacto() {
    // obtener datos
    let nombre = document.getElementById('nombre').value;
    let apellido = document.getElementById('apellido').value;
    let correo = document.getElementById('correo').value;
    let telefono = document.getElementById('telefono').value;
    //cerrar modal

    bootstrap.Modal.getInstance(document.getElementById('crearContactoModal')).hide();
    //eliminar tabla
    eliminarTabla();
    // crear loader
    crearLoaderPuntos('divContactos');

    google.script.run
      .withSuccessHandler(contactoInsertadoCorrectamente)
      .withFailureHandler(contactoInsertadoError)
      .insertarContacto(nombre, apellido, correo, telefono);
  }

  function contactoInsertadoCorrectamente() {
    // eliminamos datos
    document.getElementById('nombre').value = '';
    document.getElementById('apellido').value = '';
    document.getElementById('correo').value = '';
    document.getElementById('telefono').value = '';
    // mostrar notificacion
    crearNotificacionContacto('Contacto insertado correctamente', 'Contacto OK');
    // eliminar loader
    eliminarLoader();
    //mostramos la tabla
    crearTablaContactos();
  }
  function contactoInsertadoError() {
    crearNotificacionError('No se ha podido insertar el contacto', 'ERROR')
    eliminarLoader();
    crearTablaContactos();
  }

  function crearTablaContactos() {
    // borrar tabla
    eliminarTabla();

    // crear loader
    crearLoaderPuntos('divContactos');

    google.script.run
      .withSuccessHandler(crearTablaContactosCorrectamente)
      .withFailureHandler(crearTablaContactosError)
      .obtenerContactos();
  }

  function crearTablaContactosCorrectamente(obj) {
    tabla = document.createElement('table');
    tabla.id = 'tablaContactos'
    eliminarLoader();
    let tablaHeader = document.createElement('thead');
    let tablabody = document.createElement('tbody');

    //header de la tabla
    let primerafila = document.createElement('tr');
    for (let i = 0; i < obj[0].length; i++) {
      let celda = document.createElement('td');
      celda.textContent = obj[0][i];
      primerafila.appendChild(celda);
    }

    //agregar columna opciones
    let celdaOpciones = document.createElement('td');
    celdaOpciones.textContent = 'OPCIONES';
    celdaOpciones.classList.add('text-center');
    primerafila.appendChild(celdaOpciones);

    //agregar la fila al header de la tabla
    tablaHeader.appendChild(primerafila);
    tabla.appendChild(tablaHeader);

    //body de la tabla
    for (let i = 1; i < obj.length; i++) {
      let fila = document.createElement('tr');
      for (let j = 0; j < obj[i].length; j++) {
        let celda = document.createElement('td');
        celda.textContent = obj[i][j];
        fila.appendChild(celda);
      }
      // crear botonos fila
      fila.appendChild(crearCeldaBotones(i+1, obj[i]));
      tablabody.appendChild(fila);
    }

    //agregamos clases a la cabecera
    tablaHeader.classList.add('table-dark');
    // agregamos cuerpo a la tabla
    tabla.appendChild(tablabody);
    // agregamos clases a la tabla
    tabla.classList.add('table', 'table-striped', 'border', 'border-4', 'border-dark');
    // agregramos tabla a la pagina
    document.getElementById('divContactos').appendChild(tabla);

    // mostrar notificacion ok
    crearNotificacionOk('Contactos obtenidos correctamente', 'Todo en orden')
    // elinimanos loader
    eliminarLoader();
  }

  function crearCeldaBotones(numFila, datosContacto) {  //crear celda
    //crear celda
    let celda = document.createElement('td');
    celda.classList.add('text-center');

    // crear boton borrar
    let botonBorrar = document.createElement('button');
    botonBorrar.onclick = () => borrarContacto(numFila);
    botonBorrar.classList.add('btn', 'btn-danger', 'm-1');
    
    //icono borrar
    let iconoBorrar = document.createElement('i');
    iconoBorrar.classList.add('bi', 'bi-trash');
    botonBorrar.appendChild(iconoBorrar);


    //crear noton modificar
    let botonModificar = document.createElement('button');
     botonModificar.onclick = () => abrirModalModificarContacto(numFila, datosContacto);
     botonModificar.classList.add('btn', 'btn-warning', 'm-1');
   

    //icono modificar
    let iconoModificar = document.createElement('i');
    iconoModificar.classList.add('bi', 'bi-pencil-square');
    botonModificar.appendChild(iconoModificar);


    //agregar botones
    celda.appendChild(botonBorrar);
    celda.appendChild(botonModificar);
    return celda;
  }

  function abrirModalCrearContacto()
  {
     //boton crear
     let boton = document.getElementById('botonCrearModificar');
    boton.textContent = "Crear contacto";
    boton.classList='';
    boton.classList.add('btn','btn-success');

    //cambiar titulo
    document.getElementById('tituloModal').textContent= 'Crear contacto';
    // modificar submit
    document.getElementById('formulario').onsubmit = () => insertarContacto();

    //obtener datos
    document.getElementById('nombre').value= '';
    document.getElementById('apellido').value= '';
    document.getElementById('correo').value= '';
    document.getElementById('telefono').value= '';
    
    //abrir modal
    bootstrap.Modal.getOrCreateInstance(document.getElementById('crearContactoModal')).show();
  
  }



  function abrirModalModificarContacto(numFila, datosContacto)
  {
    //boton modificar
    let boton = document.getElementById('botonCrearModificar');
    boton.textContent = "Modificar contacto";
    boton.classList='';
    boton.classList.add('btn','btn-warning');

    //cambiar titulo
    document.getElementById('tituloModal').textContent= 'Modificar contacto';
    // modificar submit
    document.getElementById('formulario').onsubmit = () => modificarContacto(numFila);

    //obtener datos
    document.getElementById('nombre').value= datosContacto[0];
    document.getElementById('apellido').value= datosContacto[1];
    document.getElementById('correo').value= datosContacto[2];
    document.getElementById('telefono').value= datosContacto[3];
    
    //abrir modal
    bootstrap.Modal.getOrCreateInstance(document.getElementById('crearContactoModal')).show();
  
  }
  function modificarContacto(numFila) {
    //cerrar modal
    bootstrap.Modal.getOrCreateInstance(document.getElementById('crearContactoModal')).hide();
    // obtener nuevo datos a partod del formulario
    let nombre = document.getElementById('nombre').value;
    let apellido = document.getElementById('apellido').value;
    let correo = document.getElementById('correo').value;
    let telefono = document.getElementById('telefono').value;
    
    //eliminar tabla
    eliminarTabla();
    // crear loader
    crearLoaderPuntos('divContactos');
    eliminarLoader();
    google.script.run
      .withSuccessHandler(contactoModificadoCorrectamente)
      .withFailureHandler(contactoModificadoError)
      .modificarContacto(numFila, {nombre,apellido,correo,telefono});
  }

  function borrarContacto(numFila) {
    //eliminar tabla
    eliminarTabla();
    // crear loader
    crearLoaderPuntos('divContactos');
    eliminarLoader();
    google.script.run
      .withSuccessHandler(contactoBorradoCorrectamente)
      .withFailureHandler(contactoBorradoError)
      .borrarContacto(numFila);
  }
  function contactoModificadoCorrectamente() {
    crearNotificacionContacto('Contacto modificado correctamente', 'MODIFICADO OK');
    eliminarLoader();
    crearTablaContactos();
  }

  function contactoModificadoError() {
    crearNotificacionError('No se ha podido modificar el contacto', 'ERROR')
    eliminarLoader();
    crearTablaContactos();
  }


  function contactoBorradoCorrectamente() {
    crearNotificacionBorrar('Contacto borrado correctamente', 'BORRADO OK');
    eliminarLoader();
    crearTablaContactos();
  }

  function contactoBorradoError() {
    crearNotificacionError('No se ha podido borrar el contacto', 'ERROR')
    eliminarLoader();
    crearTablaContactos();
  }



  function crearTablaContactosError() {
    //mostrar notificacion error
    crearNotificacionAdvertencia('Contactos no obtenidos ', 'ERROR')
    eliminarLoader();
  }
 
  function crearLoader(elementoPadre) {
    eliminarLoader();
    let loader = document.createElement('div');
    loader.id = 'loader';
    loader.appendChild(document.createElement('div'));
    loader.appendChild(document.createElement('div'));
    loader.appendChild(document.createElement('div'));
    loader.appendChild(document.createElement('div'));

    return document.getElementById(elementoPadre).appendChild(loader);
  }
  function crearLoaderPuntos(elementoPadre) {
    let loader = crearLoader(elementoPadre);
    loader.classList.add('lds-ellipsis');
  }
  function crearLoaderAnillos(elementoPadre) {
    let loader = crearLoader(elementoPadre);
    loader.classList.add('lds-ring');
  }
  function eliminarLoader() {
    let loader = document.getElementById('loader');
    if (loader) loader.remove();
  }
  function eliminarTabla() {
    let tabla = document.getElementById('tablaContactos');
    if (tabla) tabla.remove();

  }

//
//NOTIFICACIONES
//
  const ICONO_CHECK = 'bi-check2-square';
  const ICONO_PAPELERA = 'bi-trash';
  const ICONO_CONTACTO = "bi-person-plus-fill";
  const ICONO_ERROR = 'bi-bug';
  const ICONO_ADVERTENCIA = 'bi-exclamation-square' 
  function crearNotificacionOK(mensaje, titulo)
  {
    crearNotificacion(titulo,mensaje,ICONO_CHECK,'--color-verde-oscuro')
  }
  function crearNotificacionError(mensaje, titulo)
  {
    crearNotificacion(titulo,mensaje,ICONO_ERROR,'--color-rojo-oscuro')
  }
  function crearNotificacionContacto(mensaje, titulo)
  {
    crearNotificacion(titulo,mensaje,ICONO_CONTACTO,'--color-azul-oscuro')
  }
  function crearNotificacionAdvertencia(mensaje, titulo)
  {
    crearNotificacion(titulo,mensaje,ICONO_ADVERTENCIA,'--color-amarillo-oscuro')
  }
  function crearNotificacionBorrar(mensaje, titulo)
  {
    crearNotificacion(titulo,mensaje,ICONO_PAPELERA,'--color-gris-oscuro')
  }

function crearNotificacion(titulo, mensaje, icono ,color)
{
  let notificacion = crearAtributosNotificacion();
  let cabeceraNotificacion = crearCabeceraNotificacion(titulo, icono);
  let cuerpoNotificacion = crearCuerpoNotificacion(mensaje);
  //agregar cabecera y cuerpo
  notificacion.appendChild(cabeceraNotificacion);
  notificacion.appendChild(cuerpoNotificacion);
  //esatablecer color
  notificacion.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue(color);

  //evento
  notificacion.addEventListener('hidden.bs.toast', function()
  {
    this.remove();
  });
  //agregamos al contenedtor
  document.getElementById('contenedorNotificaciones').appendChild(notificacion);
  //Iinstancia y mostrar
  bootstrap.Toast.getOrCreateInstance(notificacion).show();
}
function crearCuerpoNotificacion(mensaje)
{
  let cuerpoNotificacion = document.createElement('div');
  cuerpoNotificacion.classList.add('toast-body');
  cuerpoNotificacion.textContent =mensaje;
  return cuerpoNotificacion;
}

function crearCabeceraNotificacion(titulo, icono)
{
  //crear cabercera
  let cabeceraNotificacion = document.createElement('div');
  cabeceraNotificacion.classList.add('toast-header','p-0');
  // crear icono pasando el contenedor
  crearIconoNotificacion(cabeceraNotificacion, icono);
  //crear el titulo 
  let tituloNotificacion = document.createElement('strong');
  tituloNotificacion.classList.add('mx-2');
  tituloNotificacion.textContent = titulo;
  cabeceraNotificacion.appendChild(tituloNotificacion);
  return cabeceraNotificacion;
}

function crearIconoNotificacion(contenedor, icono)
{
let divIcono = document.createElement('div');
let iconoNotificacion = document.createElement('i');
divIcono.classList.add('icono-notificacion');
iconoNotificacion.classList.add('bi',icono);
divIcono.appendChild(iconoNotificacion);
contenedor.appendChild(divIcono);

}

function crearAtributosNotificacion()
{
  let notificacion = document.createElement('div');
  notificacion.classList.add('toast','align-items-center','text-white','border-0');
  notificacion.setAttribute('role', 'alert');
  notificacion.setAttribute('aria-live','assertive');
  notificacion.setAttribute('aria-atomic','true');
  return notificacion;
}

</script>